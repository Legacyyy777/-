<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö–æ–¥ - VPN Subscription</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .logo {
            font-size: 60px;
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .telegram-login-wrapper {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .features {
            text-align: left;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #eee;
        }

        .feature {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            color: #555;
        }

        .feature-icon {
            font-size: 24px;
            margin-right: 15px;
        }

        .loading {
            display: none;
            margin-top: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .error.active {
            display: block;
        }
    </style>
</head>

<body>
    <div class="login-container">
        <div class="logo">üöÄ</div>
        <h1>VPN Subscription</h1>
        <p>–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–µ–π –ø–æ–¥–ø–∏—Å–∫–æ–π</p>

        <div class="telegram-login-wrapper">
            <script async src="https://telegram.org/js/telegram-widget.js?22" data-telegram-login="YOUR_BOT_USERNAME"
                data-size="large" data-radius="10" data-onauth="onTelegramAuth(user)" data-request-access="write">
                </script>
        </div>

        <div class="loading">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #666;">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...</p>
        </div>

        <div class="error">
            <strong>–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</strong>
            <p id="error-message"></p>
        </div>

        <div class="features">
            <div class="feature">
                <span class="feature-icon">‚ö°</span>
                <span>–ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –ø–æ–¥–ø–∏—Å–∫–µ</span>
            </div>
            <div class="feature">
                <span class="feature-icon">üí≥</span>
                <span>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</span>
            </div>
            <div class="feature">
                <span class="feature-icon">üìä</span>
                <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</span>
            </div>
            <div class="feature">
                <span class="feature-icon">üéÅ</span>
                <span>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</span>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const API_URL = window.location.origin + '/api';

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram
        function onTelegramAuth(user) {
            console.log('Telegram Auth:', user);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
            document.querySelector('.loading').classList.add('active');
            document.querySelector('.error').classList.remove('active');

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ backend –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            fetch(API_URL + '/miniapp/auth/telegram-login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: user.id,
                    first_name: user.first_name,
                    last_name: user.last_name,
                    username: user.username,
                    photo_url: user.photo_url,
                    auth_date: user.auth_date,
                    hash: user.hash,
                }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ localStorage
                        localStorage.setItem('auth_token', data.token);
                        localStorage.setItem('user_id', user.id);

                        // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                        window.location.href = '/';
                    } else {
                        throw new Error(data.error || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                    }
                })
                .catch(error => {
                    console.error('Auth error:', error);
                    document.querySelector('.loading').classList.remove('active');
                    document.querySelector('.error').classList.add('active');
                    document.getElementById('error-message').textContent = error.message;
                });
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        window.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('auth_token');
            if (token) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞
                fetch(API_URL + '/miniapp/auth/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token,
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // –£–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, —Ä–µ–¥–∏—Ä–µ–∫—Ç
                            window.location.href = '/';
                        }
                    })
                    .catch(() => {
                        // –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π, —É–¥–∞–ª—è–µ–º
                        localStorage.removeItem('auth_token');
                        localStorage.removeItem('user_id');
                    });
            }
        });
    </script>
</body>

</html>